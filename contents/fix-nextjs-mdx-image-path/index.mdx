---
emoji: 'ğŸ–¼ï¸'
title: 'Next.js MDX ì´ë¯¸ì§€ ê²½ë¡œ ë¬¸ì œ í•´ê²°'
description: 'í¸ì˜ì„± ì¸¡ë©´ì—ì„œ í•´ê²°í•˜ê¸°'
tags:
  - blog
  - mdx
  - trouble shooting
date: 2024-11-24
---

## ë§ˆì£¼ì¹œ ëª‡ ê°€ì§€ ë¬¸ì œ

ê°œë°œ ì¤‘ ëª‡ ê°€ì§€ ë¬¸ì œë¥¼ ê²ªì—ˆëŠ”ë° ëŒ€ë¶€ë¶„ Gatsby í”ŒëŸ¬ê·¸ì¸ì´ ìë™ìœ¼ë¡œ í•´ì£¼ë˜ ê¸°ëŠ¥ì´ ì‚¬ë¼ì ¸ì„œ ìƒê¸´ ê²ƒë“¤ì´ì—ˆìŠµë‹ˆë‹¤.

ì‚¬ì‹¤ ì°¾ì•„ë³´ë©´ íŒ¨í‚¤ì§€ê°€ ìˆì„ ê²ƒ ê°™ê¸´í•œë° ì¼ë¶€ë¥¼ ì§ì ‘ í•´ê²°í•´ë´¤ìŠµë‹ˆë‹¤.

### ì´ë¯¸ì§€ ì ˆëŒ€ ê²½ë¡œ

ì•ì„œ MDXì™€ ì´ë¯¸ì§€ë¥¼ ê°™ì€ ê³³ì—ì„œ ê´€ë¦¬í•œë‹¤ê³  í–ˆìŠµë‹ˆë‹¤. ê·¸ë˜ì„œ ì €ëŠ” MDXì—ì„œ ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ë•Œ `![](0.png)`ì™€ ê°™ì´ ìƒëŒ€ ê²½ë¡œë¡œ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤. ê¸°ì¡´ì—ëŠ” ë¬¸ì œê°€ ì—†ì—ˆëŠ”ë° ë§ˆì´ê·¸ë ˆì´ì…˜ ì´í›„ì— ê²½ë¡œë¥¼ ì°¾ì§€ ëª»í•˜ëŠ” ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.

![](0.png 'ë°”ë¡œ ì˜†ì— ìˆëŠ”ë°ìš”?')

ìš”ì²­ URLì„ ìì„¸íˆ ë³´ë‹ˆ `(root)/0.png`ì™€ ê°™ì´ ì ˆëŒ€ ê²½ë¡œë¡œ ì´ë¯¸ì§€ë¥¼ ìš”ì²­í•˜ê³  ìˆì—ˆìŠµë‹ˆë‹¤.

ê·¸ëŸ¼ ë‹¨ìˆœí•˜ê²Œ `public` ë””ë ‰í† ë¦¬ì—ì„œ ì´ë¯¸ì§€ë¥¼ ê´€ë¦¬í•˜ë©´ ëê² ì§€ë§Œ ê·¸ëŸ¬ê³  ì‹¶ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤... ì´ë¯¸ì§€ë¥¼ ì‚½ì… í•  ë•Œë§ˆë‹¤ ë””ë ‰í† ë¦¬ë¥¼ ì˜®ê²¨ë‹¤ë‹ˆê³  ê°ê¸° ë‹¤ë¥¸ íŒŒì¼ ì´ë¦„ì„ ì§“ëŠë¼ ê³ ë¯¼í•˜ëŠ” ê³¼ì •ì´ ë³µì¡í•´ë³´ì˜€ìŠµë‹ˆë‹¤.

ê·¸ë˜ì„œ ì´ ë¶€ë¶„ì€ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì´ìš©í•˜ê¸°ë¡œ í–ˆìŠµë‹ˆë‹¤. ë°©ë²•ì€ ê°œë°œ ì„œë²„ë¥¼ ì‹¤í–‰í•˜ê±°ë‚˜ ë¹Œë“œ í•  ë•Œ ì´ë¯¸ì§€ë“¤ì„ `public` ë””ë ‰í† ë¦¬ì— ë³µì‚¬í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. ë‹¤ë§Œ ë‹¨ìˆœíˆ `public` ì•ˆì— ë³µì‚¬í•˜ë©´ ëª¨ë“  ì´ë¯¸ì§€ ì´ë¦„ì´ ë‹¬ë¼ì•¼í•˜ê¸° ë•Œë¬¸ì— `public/images/[í¬ìŠ¤íŠ¸ URL]` ì•ˆì— ë³µì‚¬ë˜ë„ë¡ í–ˆìŠµë‹ˆë‹¤.

```js pre-script.js
import { access, constants, copyFile, mkdir, readdir, rm } from 'fs/promises';
import path from 'path';

const SOURCE_DIR = path.join(process.cwd(), 'contents');
const TARGET_DIR = path.join(process.cwd(), 'public/images');

// !collapse(1:7) collapsed
const exists = async (path) => {
  try {
    await access(path, constants.F_OK);
    return true;
  } catch {
    return false;
  }
};

const copyImages = async () => {
  const entries = await readdir(SOURCE_DIR, { withFileTypes: true });
  const dirs = entries.filter((entry) => entry.isDirectory()).map((entry) => entry.name);

  if (await exists(TARGET_DIR)) await rm(TARGET_DIR, { recursive: true });

  for await (const dir of dirs) {
    const sourceDirPath = path.resolve(path.join(SOURCE_DIR, dir));
    const targetDirPath = path.resolve(path.join(TARGET_DIR, dir));
    const entries = await readdir(sourceDirPath, { withFileTypes: true });
    const files = entries.filter((entry) => !entry.isDirectory()).map((entry) => entry.name);
    // !mark
    const imageFiles = files.filter((file) => /.(png|gif)$/.test(file));

    if (imageFiles.length === 0) continue;

    await mkdir(targetDirPath, { recursive: true });

    await Promise.all(
      imageFiles.map((imageFile) => {
        // !mark(1:2)
        const sourceFilePath = path.resolve(path.join(sourceDirPath, imageFile));
        const targetFilePath = path.resolve(path.join(targetDirPath, imageFile));

        // !mark
        copyFile(sourceFilePath, targetFilePath);
      })
    );
  }
};

await copyImages();
```

![](1.png 'ì˜ ë³µì‚¬ëœ ì´ë¯¸ì§€ë“¤')

ê·¸ëŸ°ë° `public/images/[í¬ìŠ¤íŠ¸ URL]` ì•ˆì— ë³µì‚¬í–ˆê¸° ë•Œë¬¸ì— MDXì—ì„œ `![](images/[í¬ìŠ¤íŠ¸ URL]/0.png)`ì™€ ê°™ì´ ì‘ì„±í•´ì•¼ë©ë‹ˆë‹¤. `![](0.png)`ê³¼ ê°™ì´ ê°™ì€ ë””ë ‰í† ë¦¬ì— ìˆëŠ” ì´ë¯¸ì§€ ì´ë¦„ë§Œ ì…ë ¥í•´ë„ ì•Œì•„ì„œ ì˜ ì°¾ì•„ì£¼ë©´ ì–¼ë§ˆë‚˜ ì¢‹ì„ê¹Œìš”.

ê°„ë‹¨í•œ `remark` í”ŒëŸ¬ê·¸ì¸ì„ ë§Œë“¤ì–´ì„œ ë¹Œë“œ ë‹¨ê³„ì—ì„œ `img`ì˜ `src`ë¥¼ ìˆ˜ì •í•´ë³´ê² ìŠµë‹ˆë‹¤.

```js remark-public-image.js
import { visit } from 'unist-util-visit';

const remarkPublicImage = () => {
  return (tree, file) => {
    // file.history => [(root)/[í¬ìŠ¤íŠ¸ URL]/index.mdx]
    const path = file.history.at(0).split('/').at(-2);

    visit(tree, 'image', (node) => {
      // !mark
      node.url = `/images/${path}/${node.url}`;
    });
  };
};
```

ë§Œë“  í”ŒëŸ¬ê·¸ì¸ì€ `next.config.mjs`ì— ì¶”ê°€í•´ì¤ë‹ˆë‹¤.

```js
import remarkPublicImage from './scripts/remark-public-image.mjs';

const withMDX = createMDX({
  options: {
    ...
    remarkPlugins: [remarkPublicImage],
  },
});

export default withMDX(nextConfig);
```

<Callout>

MDX ë¬¸ë²•ìœ¼ë¡œ ì‘ì„±ë§Œ í–ˆëŠ”ë° ì–´ë–»ê²Œ ë¸Œë¼ìš°ì €ì— ë Œë”ë§ ë˜ëŠ”ê±¸ê¹Œìš”?

ëˆ„êµ°ê°€ ë³€í™˜ì„ í•´ì£¼ê³  ìˆìŠµë‹ˆë‹¤. ì œ ë¸”ë¡œê·¸ì˜ ê²½ìš° `@mdx-js/mdx`ê°€ ê·¸ ì—­í• ì„ í•˜ê³  ìˆìŠµë‹ˆë‹¤.

ê°„ëµí•˜ê²Œ MDX -> MDAST(Markdown Abstract Syntax Tree) -> HAST(HTML Abstract Syntax Tree) -> JSX ìˆœìœ¼ë¡œ ë³€í™˜ë©ë‹ˆë‹¤.

í”ŒëŸ¬ê·¸ì¸ë“¤ì€ ì´ëŸ° ë³€í™˜ ê³¼ì •ì— ê°œì…í•´ì„œ ì¶”ìƒ êµ¬ë¬¸ íŠ¸ë¦¬ë¥¼ ì¡°ì‘ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì œê°€ í”ŒëŸ¬ê·¸ì¸ì„ ë§Œë“¤ë©´ì„œ `unist-util-visit`ì„ í†µí•´ `src`ë¥¼ ìˆ˜ì • í•  ìˆ˜ ìˆì—ˆë˜ ì´ìœ ì…ë‹ˆë‹¤.

</Callout>

ì´ì œ ë§ˆë¬´ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤. ê·¸ëŸ°ë° ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë§¤ë²ˆ ì‹¤í–‰í•˜ê¸° ê·€ì°®ê¸° ë•Œë¬¸ì— `package.json`ì„ ìˆ˜ì •í•´ì¤ë‹ˆë‹¤.

```json package.json
"scripts": {
  "prebuild": "node ./scripts/pre-script.mjs",
  "build": "next build",
  "predev": "node ./scripts/pre-script.mjs",
  "dev": "next dev",
}
```

ê·¸ë¦¬ê³  ì‹¤í–‰ ì‹œ ìë™ìœ¼ë¡œ ìƒì„±ë˜ê¸° ë•Œë¬¸ì— ì›ê²© ì €ì¥ì†Œì— ì˜¬ë¼ê°ˆ í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤. `.gitignore`ì—ë„ ì¶”ê°€í•´ì¤ë‹ˆë‹¤.

```json .gitignore
# asset
/public/images/*
```
