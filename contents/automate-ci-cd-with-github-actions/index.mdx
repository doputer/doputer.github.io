---
emoji: 'ğŸ¤–'
title: 'GitHub Actionsë¡œ CI/CD ìë™í™”í•˜ê¸°'
description: 'ìë™í™”ë¥¼ ë¶€íƒí•´'
tags:
  - ci/cd
  - github actions
date: 2022-12-06
---

## ì„œë¹„ìŠ¤ê°€ ì‚¬ìš©ìì—ê²Œ ë‹¿ê¸°ê¹Œì§€

[Knoticle](https://github.com/boostcampwm-2022/web01-knoticle) ì„œë¹„ìŠ¤ë¥¼ ê°œë°œí•˜ë©´ì„œ GitHub Actionsë¡œ CI/CDë¥¼ êµ¬ì„±í•œ ê²½í—˜ì„ ê³µìœ í•©ë‹ˆë‹¤.

ê°œë°œë¶€í„° ë°°í¬ê¹Œì§€ ì•„ë˜ì™€ ê°™ì€ ê³¼ì •ì„ ê±°ì³¤ìŠµë‹ˆë‹¤.

1. ì½”ë“œ í†µì¼í•˜ê¸°

- Eslintë¡œ ì½”ë“œ ìŠ¤íƒ€ì¼ ê²€ì‚¬
- íŒ€ì›ë“¤ì˜ ì½”ë“œê°€ í†µì¼ëœ ìŠ¤íƒ€ì¼ì„ ìœ ì§€í•˜ëŠ”ì§€ í™•ì¸

2. ë™ì‘ í™•ì¸í•˜ê¸°

- ë¹Œë“œë¥¼ í†µí•´ ì½”ë“œê°€ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•˜ëŠ”ì§€ í™•ì¸
- ìƒˆë¡œìš´ ì½”ë“œê°€ ê¸°ì¡´ ì„œë¹„ìŠ¤ì™€ ì˜ í†µí•©ë˜ëŠ”ì§€ í™•ì¸

3. ì§€í‘œ í™•ì¸í•˜ê¸°

- Lighthouseë¡œ ì„±ëŠ¥ ì§€í‘œ ì ê²€
- ì¼ì • ìˆ˜ì¤€ì˜ ì„œë¹„ìŠ¤ í’ˆì§ˆì„ ìœ ì§€í•˜ê¸° ìœ„í•œ ì§€í‘œ í™•ë³´

4. ì„œë¹„ìŠ¤ ì œê³µí•˜ê¸°

- í…ŒìŠ¤íŠ¸ë¥¼ í†µê³¼í•œ ì½”ë“œë¥¼ í´ë¼ìš°ë“œì— ë°°í¬
- ë¬´ì¤‘ë‹¨ ë°°í¬ë¡œ ì‚¬ìš©ìì—ê²Œ ì§€ì†ì ì¸ ì„œë¹„ìŠ¤ ì œê³µ

## CI/CD ìë™í™”

ì´ í”„ë¡œì íŠ¸ì—ì„œëŠ” ë§¤ì£¼ ë°ëª¨ ì‹œì—°ì„ í•˜ê³ , ì‚¬ìš©ì í”¼ë“œë°±ì„ ë¹ ë¥´ê²Œ ë°˜ì˜í•˜ê¸° ìœ„í•´ ë¹ˆë²ˆí•œ ë°°í¬ê°€ í•„ìš”í–ˆìŠµë‹ˆë‹¤.

ìˆ˜ë™ ë°°í¬ëŠ” ë¹„íš¨ìœ¨ì ì´ì—ˆê¸° ë•Œë¬¸ì— GitHub Actionsë¥¼ ì‚¬ìš©í•´ ë°°í¬ í”„ë¡œì„¸ìŠ¤ë¥¼ ìë™í™”í•˜ê³  ê°œë°œì— ì§‘ì¤‘í•  ìˆ˜ ìˆë„ë¡ í–ˆìŠµë‹ˆë‹¤.

### í”„ë¡ íŠ¸ì—”ë“œ CI

í”„ë¡ íŠ¸ì—”ë“œ CIëŠ” main ë¸Œëœì¹˜ì™€ develop ë¸Œëœì¹˜ì— PRì´ ìƒì„±ë  ë•Œ ìë™ìœ¼ë¡œ ìˆ˜í–‰ë©ë‹ˆë‹¤.

```yaml
name: Frontend CI

on:
  pull_request:
    branches: [main, develop]
    paths:
      - 'frontend/**'
```

ì´í›„ Eslint ê²€ì‚¬, Lighthouse ê²€ì‚¬ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤.

```yaml
jobs:
  lint: ...
  lighthouse: ...
```

GitHub Actionsì—ì„œ jobì€ ë…ë¦½ì ìœ¼ë¡œ ì‹¤í–‰í•˜ëŠ” ë‹¨ìœ„ì…ë‹ˆë‹¤. jobì— ë“¤ì–´ìˆëŠ” ì‘ì—…ë“¤ì€ ë³‘ë ¬ì ìœ¼ë¡œ ì‹¤í–‰ë©ë‹ˆë‹¤. ë‘ ê³¼ì •ì„ ë³‘ë ¬ ì²˜ë¦¬í•´ì„œ CI ì‹œê°„ì„ ë‹¨ì¶•í•˜ê³ ìí–ˆìŠµë‹ˆë‹¤.

ì´ì œ ê³¼ì •ì„ í•˜ë‚˜ì”© ë³´ê² ìŠµë‹ˆë‹¤.

```yaml
lint:
  name: Lint CI

  runs-on: ubuntu-latest

  steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Cache Dependencies
      uses: actions/cache@v3
      id: frontend-cache
      with:
        path: frontend/node_modules
        key: ${{ runner.OS }}-build-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.OS }}-build-
          ${{ runner.OS }}-

    - if: ${{ steps.frontend-cache.outputs.cache-hit != 'true' }}
      name: Install Dependencies
      run: npm install
      working-directory: frontend

    - name: Check Lint
      run: npm run lint
      env:
        CI: true
      working-directory: frontend
```

ìš°ì„  lint job ì…ë‹ˆë‹¤.

ì‹¤ì œë¡œ ë¦°íŠ¸ ê²€ì‚¬ë¥¼ ìˆ˜í–‰í•˜ëŠ” ë¶€ë¶„ì€ ë§ˆì§€ë§‰ì— ìˆëŠ” **Check Lint** ìŠ¤í…ì…ë‹ˆë‹¤.

ê·¸ëŸ°ë° ì•ì„  ìŠ¤í…ë“¤ì€ ë¬´ì—‡ì¼ê¹Œìš”?

**Checkout** ìŠ¤í…ì—ì„œëŠ” ì½”ë“œ ì €ì¥ì†Œì— ìˆëŠ” ì½”ë“œë¥¼ CI ê³¼ì •ì„ ìˆ˜í–‰í•˜ëŠ” ì„œë²„ë¡œ ë‚´ë ¤ë°›ìŠµë‹ˆë‹¤.

ì´í›„ **Install Dependencies** ìŠ¤í…ì—ì„œ í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ì‚¬ìš©í•˜ëŠ” ëª¨ë“ˆì„ ì„¤ì¹˜í•©ë‹ˆë‹¤. ì´ë•Œ ëª¨ë“ˆë“¤ì€ ì„¤ì¹˜í•˜ëŠ”ë° ì˜¤ë˜ ê±¸ë¦¬ê¸°ë„ í•˜ê³ , ìì£¼ ë³€ê²½ë˜ì§€ ì•Šê¸° ë•Œë¬¸ì— ìºì‹±í•´ë†“ê¸° ì ì ˆí•´ë³´ì…ë‹ˆë‹¤.

ê·¸ë˜ì„œ ì„¤ì¹˜ ê³¼ì • ë°”ë¡œ ì§ì „ ìŠ¤í…ì¸ **Cache Dependencies**ì—ì„œ ëª¨ë“ˆ ìºì‹±ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤. ëª¨ë“ˆì„ ì„¤ì¹˜í•˜ë©´ ë³€ê²½ë˜ëŠ” `package-lock.json` íŒŒì¼ ë‚´ìš©ì„ í‚¤ë¡œ ë§Œë“¤ì–´ì„œ íŒŒì¼ì´ ë³€ê²½ë˜ì—ˆì„ ë•Œë§Œ ëª¨ë“ˆì„ ì„¤ì¹˜í•˜ê³ , ë³€ê²½ë˜ì§€ ì•Šì•˜ë‹¤ë©´ GitHubì— ì €ì¥í•´ë†“ì€ ëª¨ë“ˆ ì„¤ì¹˜ íŒŒì¼ì„ êº¼ë‚´ë‹¤ ì”ë‹ˆë‹¤.

```yaml
lighthouse:
  name: Lighthouse CI

  runs-on: ubuntu-latest

  steps:

    ... (ìƒëµ)

    - name: Run Lighthouse CI
      env:
        LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
      run: |
        npm install -g @lhci/cli
        lhci autorun
      working-directory: frontend

    - name: Format Lighthouse Score
      id: format_lighthouse_score
      uses: actions/github-script@v3
      with:
        github-token: ${{secrets.GITHUB_TOKEN}}
        script: |
          const fs = require('fs');

          const results = JSON.parse(fs.readFileSync('frontend/lighthouse_reports/manifest.json'));

          const summaryTotal = {};

          results.forEach((result) => {
            const { summary } = result;

            const formatResult = (res) => Math.round(res * 100);

            Object.keys(summary).forEach((key) => {
              if (key in summaryTotal) summaryTotal[key] += formatResult(summary[key]);
              else summaryTotal[key] = formatResult(summary[key]);
            });
          });

          Object.keys(summaryTotal).forEach((key) => {
            summaryTotal[key] = Math.round(summaryTotal[key] / results.length);
          });

          const score = (res) => (res >= 90 ? 'ğŸŸ¢' : res >= 50 ? 'ğŸŸ ' : 'ğŸ”´');

          const comment = [
            `âš¡ï¸ Lighthouse report!`,
            `| Category | Score |`,
            `| --- | --- |`,
            `| ${score(summaryTotal.performance)} Performance | ${summaryTotal.performance} |`,
            `| ${score(summaryTotal.accessibility)} Accessibility | ${summaryTotal.accessibility} |`,
            `| ${score(summaryTotal['best-practices'])} Best Practices | ${summaryTotal['best-practices']} |`,
            `| ${score(summaryTotal.seo)} SEO | ${summaryTotal.seo} |`,
            `| ${score(summaryTotal.pwa)} PWA | ${summaryTotal.pwa} |`,
          ].join('\n');

          core.setOutput('comment', comment)

    - name: Comment Lighthouse Report
      uses: unsplash/comment-on-pr@v1.3.0
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        msg: ${{ steps.format_lighthouse_score.outputs.comment}}
```

ë‹¤ìŒì€ lighthouse job ì…ë‹ˆë‹¤.

**Run Lighthouse CI** ìŠ¤í…ì—ì„œ Lighthouse ê²€ì‚¬ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤.

```js .lighthouserc.js
module.exports = {
  ci: {
    collect: {
      startServerCommand: 'npm run start',
      url: ['http://localhost:3000'],
      numberOfRuns: 3,
    },
    upload: {
      target: 'filesystem',
      outputDir: './lighthouse_reports',
      reportFilenamePattern: '%%PATHNAME%%-%%DATETIME%%-report.%%EXTENSION%%',
    },
  },
};
```

ìœ„ì™€ ê°™ì´ ì‚¬ì „ì— ì •ì˜í–ˆë˜ ë°©ë²•ëŒ€ë¡œ ê²€ì‚¬ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤. í•œ ë²ˆë§Œ ê²€ì‚¬ë¥¼ ìˆ˜í–‰í•˜ì§€ ì•Šê³ , `numberOfRuns`ì— ë”°ë¼ ì„¸ ë²ˆì˜ ê²€ì‚¬ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤.

ê²€ì‚¬ë¥¼ ìˆ˜í–‰í–ˆë‹¤ë©´ ë‹¤ìŒê³¼ ê°™ì€ ìš”ì•½ ë³´ê³ ì„œ íŒŒì¼ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```json lighthouse_reports/manifest.json
[
  {
    "url": "http://localhost:3000/",
    "isRepresentativeRun": false,
    "htmlPath": "/Users/dohyeon/Development/knoticle/frontend/lighthouse_reports/_-2022_11_26_12_40_53-report.html",
    "jsonPath": "/Users/dohyeon/Development/knoticle/frontend/lighthouse_reports/_-2022_11_26_12_40_53-report.json",
    "summary": {
      "performance": 0.98,
      "accessibility": 0.94,
      "best-practices": 0.92,
      "seo": 0.8,
      "pwa": 0.3
    }
  },
  ...
]
```

ì´ëŸ° ë³´ê³ ì„œë¥¼ PR ì½”ë©˜íŠ¸ë¡œ í™•ì¸í•  ìˆ˜ ìˆë‹¤ë©´, ì‘ì—… ê³¼ì •ë§ˆë‹¤ ì§€í‘œë¡œ ì‚¼ì„ ìˆ˜ ìˆê² ì£ ?

ë’¤ì— **Format Lighthouse Score** ìŠ¤í…ê³¼ **Comment Lighthouse Report** ìŠ¤í…ì—ì„œëŠ” ë³´ê³ ì„œë¥¼ í¬ë§¤íŒ…í•´ì„œ ì½”ë©˜íŠ¸ë¡œ ë‚¨ê²¨ì£¼ëŠ” ì‘ì—…ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.

![](0.png)

### ë°±ì—”ë“œ CI

ë°±ì—”ë“œì˜ CIë„ í”„ë¡ íŠ¸ì—”ë“œì™€ ë§ˆì°¬ê°€ì§€ë¡œ main ë¸Œëœì¹˜ì™€ develop ë¸Œëœì¹˜ì— PRì´ ìƒì„±ë˜ë©´ ìˆ˜í–‰ë©ë‹ˆë‹¤.

```yaml
name: Backend CI

on:
  pull_request:
    branches: [main, develop]
    paths:
      - 'backend/**'

jobs:
  lint: ...

  build: ...
```

ë™ì¼í•œ ê³¼ì •ì„ ìˆ˜í–‰í•˜ê¸° ë•Œë¬¸ì— ìƒëµí•˜ê² ìŠµë‹ˆë‹¤.

### í”„ë¡ íŠ¸ì—”ë“œ & ë°±ì—”ë“œ CD

CI ê³¼ì •ì„ ë§ˆì¹˜ê³  ë‚˜ë©´ CD ê³¼ì •ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.

nCloud ì„œë¹„ìŠ¤ì— ì ‘ì†í•´ì„œ ë¹Œë“œí•˜ê³ , PM2 reloadë¥¼ í†µí•´ì„œ ë¬´ì¤‘ë‹¨ ì‹¤í–‰í•˜ëŠ” ê³¼ì •ì…ë‹ˆë‹¤.

í”„ë¡ íŠ¸ì—”ë“œì™€ ë°±ì—”ë“œê°€ ë™ì¼í•œ CD ê³¼ì •ì„ ìˆ˜í–‰í•˜ê¸° ë•Œë¬¸ì— í”„ë¡ íŠ¸ì—”ë“œ ê¸°ì¤€ìœ¼ë¡œë§Œ ì„¤ëª…í•˜ê² ìŠµë‹ˆë‹¤.

```yaml
name: Frontend CD

on:
  push:
    branches: [main]
    paths:
      - 'frontend/**'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Generate Environment Variables
        run: |
          echo "$FRONTEND_ENV" >> .env.production
        env:
          CI: false
          FRONTEND_ENV: '${{ secrets.FRONTEND_ENV }}'

      - name: Transfer Environment Variables with SCP
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.SSH_PORT }}
          source: '.env.production'
          target: 'knoticle/frontend'

      - name: Deploy
        uses: appleboy/ssh-action@v0.1.4
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.SSH_PORT }}
          script: ${{ secrets.SSH_FRONTEND_SCRIPT }}
```

**Generate Environment Variables** ìŠ¤í…ì—ì„œëŠ” GitHub Secretsì— ì €ì¥ëœ í™˜ê²½ ë³€ìˆ˜ë¥¼ ìƒì„±í•˜ëŠ” ê³¼ì •ì…ë‹ˆë‹¤.

ì´í›„ **Transfer Environment Variables with SCP** ìŠ¤í…ì—ì„œ SCP(Secure Copy)ë¥¼ í†µí•´ nCloud ì„œë²„ì— í™˜ê²½ ë³€ìˆ˜ë¥¼ ë³´ë‚´ê²Œ ë©ë‹ˆë‹¤. í™˜ê²½ ë³€ìˆ˜ëŠ” ì›ê²© ì €ì¥ì†Œì— ì €ì¥ë˜ì§€ ì•Šê¸° ë•Œë¬¸ì— ì´ëŸ°ì‹ìœ¼ë¡œ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ë§ˆì§€ë§‰ìœ¼ë¡œ **Deploy** ìŠ¤í…ì—ì„œ nCloudì— ì ‘ì†í•´ì„œ ì½”ë“œë¥¼ ë¹Œë“œí•˜ê³  ë¬´ì¤‘ë‹¨ ì‹¤í–‰í•˜ëŠ” ê³¼ì •ì„ ê±°ì¹©ë‹ˆë‹¤.

## ê³ ë¯¼í•´ë³¼ ì‚¬í•­

- Lighthouse ì™¸ì— [PageSpeed Insights](https://pagespeed.web.dev/)ë¥¼ ê³ ë ¤í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ê³³ì—ì„œëŠ” ì›¹ í˜ì´ì§€ì—ì„œ ì‚¬ìš©ìì˜ í™˜ê²½ í’ˆì§ˆì— ëŒ€í•œ í‰ê°€ ì ìˆ˜ë¥¼ ì œê³µí•©ë‹ˆë‹¤.
- CIì— í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ëŠ” ê³¼ì •ë„ í¬í•¨í•´ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

## ì°¸ê³  ìë£Œ

- [Lighthouse CIë¥¼ ì•Œì•„ë³´ê³  Github Actionsì— ì ìš©í•˜ê¸°](https://fe-developers.kakaoent.com/2022/220602-lighthouse-with-github-actions/)
