---
emoji: 'π“¦'
title: 'NestJSμ—μ„ FTP μ‚¬μ©ν•κΈ°'
description: 'NestJSμ—μ„ FTPλ¥Ό μ–΄λ–»κ² μ‚¬μ©ν•  μ μμ„κΉμ”'
tags:
  - article
  - nestjs
  - ftp
date: 2021-11-27
---

ν”„λ΅μ νΈλ¥Ό ν•λ‹¤κ°€ FTPλ¥Ό μ‚¬μ©ν•΄μ„ λ‚΄κ°€ κ°€μ§„ κ²μ΄νΈμ›¨μ΄μ— νμΌμ„ λ³΄λ‚Ό μΌμ΄ μƒκ²Όμµλ‹λ‹¤. FTPμ κ°λ…λ¶€ν„° ν΄λΌμ΄μ–ΈνΈ(NestJS)μ™€ μ„λ²„(ESL Gateway)λ¥Ό μ—°κ²°ν•λ©΄μ„ μ κ°€ μ‘μ—…ν• κ³Όμ •μ„ μ •λ¦¬ν•΄λ³΄λ ¤κ³  ν•©λ‹λ‹¤.

FTP κ΄€λ ¨ ν”„λ΅ν† μ½λ΅ FTPS, SFTPκ°€ μμ§€λ§ μ—¬κΈ°μ„λ” FTPμ— κ΄€ν•΄μ„λ§ λ‹¤λ£¨λ ¤κ³  ν•©λ‹λ‹¤.

## FTP λ€?

> νμΌ μ „μ†΅ ν”„λ΅ν† μ½(File Transfer Protocol, FTP)μ€ TCP/IP ν”„λ΅ν† μ½μ„ κ°€μ§€κ³  μ„λ²„μ™€ ν΄λΌμ΄μ–ΈνΈ μ‚¬μ΄μ νμΌ μ „μ†΅μ„ ν•κΈ° μ„ν• ν”„λ΅ν† μ½μ΄λ‹¤.

μμ „μ—λ” λ§μ΄ μ‚¬μ©ν• ν”„λ΅ν† μ½μ΄μ§€λ§, μ§€κΈμ€ λ³΄μ•μƒμ μ„ν—μΌλ΅ λ§μ΄ μ‚¬μ©ν•μ§€ μ•λ”λ‹¤. FTPSλ‚ SFTPλ΅ λ€μ²΄λ κ²ƒ κ°™μµλ‹λ‹¤.

FTPλ” λ‘ κ°€μ§€ λ¨λ“λ΅ λ™μ‘ν•λ”λ° **Active Modeμ™€ Passive Mode**μ…λ‹λ‹¤.

![](0.png)

μ°μ„ , Active Modeμ λ™μ‘μ„ λ‚νƒ€λ‚Έ κ·Έλ¦ΌμΈλ° λ‹¤μκ³Ό κ°™μ€ μμ„λ΅ λ™μ‘ν•©λ‹λ‹¤.

1. ν΄λΌμ΄μ–ΈνΈκ°€ μ„λ²„μ 21λ² ν¬νΈλ΅ μ ‘μ†ν• ν›„, ν΄λΌμ΄μ–ΈνΈμ—μ„ μ‚¬μ©ν•  ν¬νΈλ¥Ό μ•λ ¤μ¤€λ‹¤.
2. μ„λ²„κ°€ ν΄λΌμ΄μ–ΈνΈμ μ”μ²­μ— μ‘λ‹µν•λ‹¤.
3. μ„λ²„μ 20λ² ν¬νΈκ°€ ν΄λΌμ΄μ–ΈνΈμ—μ„ μ•λ ¤μ¤€ ν¬νΈλ΅ μ ‘μ†ν•λ‹¤.
4. ν΄λΌμ΄μ–ΈνΈκ°€ μ„λ²„μ μ”μ²­μ— μ‘λ‹µν•λ‹¤.

κ·Έλ¦Όμ—μ„ λ³Ό μ μλ“―μ΄ **μ„λ²„μ—μ„ ν΄λΌμ΄μ–ΈνΈμ— μ ‘μ†**ν•λ” κµ¬μ΅°μ…λ‹λ‹¤.

ν΄λΌμ΄μ–ΈνΈμ—μ„ λ°©ν™”λ²½ λ“±μΌλ΅ μ™Έλ¶€ μ ‘μ†μ΄ λ¶κ°€λ¥ν• μƒν™©μ΄λΌλ©΄ μ ‘μ†μ΄ λ¶κ°€λ¥ν•κ³ , μ ‘μ†μ΄ λλ”λΌλ„ μ •μƒμ μΈ λ°μ΄ν„° λ©λ΅μ„ λ¶λ¬μ¤μ§€ λ» ν•  μλ„ μμµλ‹λ‹¤. ν΄λΌμ΄μ–ΈνΈλ” λ°©ν™”λ²½ μΈλ°”μ΄λ“ ν—μ©, μ„λ²„λ” λ°©ν™”λ²½ μ•„μ›ƒλ°”μ΄λ“ ν—μ©μ„ ν†µν•΄μ„ ν•΄κ²°ν•΄μ•Ό ν•©λ‹λ‹¤.

![](1.png)

λ‹¤μμ€ Passive Modeμ λ™μ‘μ„ λ‚νƒ€λ‚Έ κ·Έλ¦ΌμΈλ° λ‹¤μκ³Ό κ°™μ€ μμ„λ΅ λ™μ‘ν•©λ‹λ‹¤.

1. ν΄λΌμ΄μ–ΈνΈκ°€ μ„λ²„μ 21λ² ν¬νΈλ΅ Passive μ ‘μ†μ„ μ‹λ„ν•λ‹¤.
2. μ„λ²„μ—μ„ μ‚¬μ©ν•  ν¬νΈλ¥Ό ν΄λΌμ΄μ–ΈνΈμ— μ•λ ¤μ¤€λ‹¤.
3. ν΄λΌμ΄μ–ΈνΈλ” μ„λ²„μ—μ„ μ•λ ¤μ¤€ ν¬νΈλ΅ μ ‘μ†μ„ μ‹λ„ν•λ‹¤.
4. μ„λ²„κ°€ ν΄λΌμ΄μ–ΈνΈμ μ”μ²­μ— μ‘λ‹µν•λ‹¤.

μ„μ—μ„ μ–ΈκΈ‰ν• Active Modeμ™€λ” λ°λ€λ΅ **ν΄λΌμ΄μ–ΈνΈμ—μ„ μ„λ²„μ— μ ‘μ†**ν•λ” κµ¬μ΅°μ…λ‹λ‹¤.

μ„λ²„μ λ°μ΄ν„° ν¬νΈκ°€ λ§‰ν€ μλ” κ²½μ° μ—°κ²°μ΄ λ¶κ°€λ¥ν•©λ‹λ‹¤. λ°μ΄ν„° ν¬νΈμ λ²”μ„λ” λ³„λ„λ΅ μ§€μ •ν•μ§€ μ•λ” κ²½μ° 1024~65535λ² ν¬νΈλ¥Ό μ‚¬μ©ν•κΈ° λ•λ¬Έμ— λ°©ν™”λ²½ μΈλ°”μ΄λ“λ¥Ό λ¨λ‘ μ—΄μ–΄λ†”μ•Ό ν•λ”λ°, λ°μ΄ν„° ν¬νΈμ λ²”μ„λ¥Ό μ§€μ •ν•΄λ†“μΌλ©΄ μ΄λ¬ν• λ¬Έμ λ¥Ό μ–΄λ μ •λ„ ν•΄κ²°ν•  μ μλ‹¤κ³  ν•©λ‹λ‹¤.

## FTP Client (NestJS)

ν”„λ΅μ νΈμ—μ„ μ„λ²„ μ¤νƒμ€ `NestJS`λ¥Ό μ‚¬μ©ν–λ”λ° μΌμ • μ‹κ°„ λ§λ‹¤ ESL Gatewayμ— csv νμΌμ„ FTP ν†µμ‹ μ„ ν†µν•΄μ„ λ³΄λ‚΄μ•Όν–μµλ‹λ‹¤.

```task.module.ts
import { FtpModule } from 'nestjs-ftp';

@Module({
  imports: [
    FtpModule.forRootFtpAsync({
      inject: [ConfigService],
      useFactory: (configService: ConfigService) => {
        return {
          host: configService.get('FTP_HOST'),
          port: configService.getNumber('FTP_PORT'),
          user: configService.get('FTP_USER'),
          password: configService.get('FTP_PASSWORD'),
          secure: configService.getBoolean('FTP_SECURE'),
        };
      },
    }),
  ]
})
```

μ κ°€ μ΄μ©ν• ν¨ν‚¤μ§€λ” `nestjs-ftp`μ…λ‹λ‹¤.

μ½”λ“ μƒμ—μ„λ” `.env` ν™κ²½ λ³€μμ—μ„ μ„¤μ • κ°’μ„ μ½μ–΄μ¬ μ μλ„λ΅ μ§μ ‘ κµ¬ν„ν• `ConfigService`λ¥Ό μ΄μ©ν–μ§€λ§ μ§μ ‘ μ…λ ¥ν•΄λ†”λ„ λ©λ‹λ‹¤. μ΄λ ‡κ² ν΄λΌμ΄μ–ΈνΈ μ„¤μ •μ΄ λλ‚λ©΄ μ„λΉ„μ¤ μ½”λ“μ—μ„ νμΌμ„ λ³΄λ‚΄μ£Όλ” μ‘μ—…μ„ ν•©λ‹λ‹¤.

```task.service.ts
try {
  const response = await this.ftpService.upload(
    `${originPath}${file}`,
    `${destinationPath}${file}`
  );

  if (response.code === 226) this.loggerService.info('ftp success');
  else if (response.code === 0) this.loggerService.error('ftp failed');
  else this.loggerService.error('ftp unknown response');
} catch (error) {
  console.log(error);
}
```

μ°μ„  μ „μ†΅ν•  νμΌμ„ μƒμ„±ν•΄μ¤λ‹λ‹¤. μ΄ν›„ `upload(origin, destination)`λ¥Ό μ΄μ©ν•΄μ„ μƒμ„±ν• νμΌμ„ λ³΄λ‚΄μ¤λ‹λ‹¤. nestjs-ftpλ” μ‘λ‹µμΌλ΅ codeμ™€ messageλ¥Ό λ³΄λ‚΄μ£Όλ”λ° μ§μ ‘ ν™•μΈ ν•΄λ³΄λ‹ 226μ΄ μ¤λ©΄ μ „μ†΅ μ„±κ³µ, 0μ΄ μ¤λ©΄ μ „μ†΅ μ‹¤ν¨μ€μµλ‹λ‹¤. λ‹¤λ¥Έ μ½”λ“κ°€ μ¤λ” κ²½μ°λ¥Ό λ€λΉ„ν•΄μ„ μμ™Έ μ²λ¦¬λ¥Ό ν•λ² λ” ν•΄μ¤¬μµλ‹λ‹¤.

ν΄λΌμ΄μ–ΈνΈ μ„¤μ •(μ—°κ²°)λ§ μ λ€λ΅ λλ©΄ ν° λ¬Έμ  μ—†μ΄ FTPλ¥Ό ν†µν•΄μ„ νμΌμ„ μ „μ†΅ν•  μ μμµλ‹λ‹¤.

## FTP Server (ESL Gateway)

ESL Gatewayλ” μ κ°€ μ§μ ‘ λ§λ“  μ„λ²„λ” μ•„λ‹κ³  FTP ν¬νΈ μ„¤μ •μ΄ λμ–΄μλ” μƒνƒλ΅ λ°›μ€ κ²μ΄νΈμ›¨μ΄μ…λ‹λ‹¤. λ‹¤λ§, μ™Έλ¶€μ—μ„ μ ‘μ†ν•κΈ° λ•λ¬Έμ— κ³µμ κΈ° ν¬νΈ ν¬μ›λ”© μ„¤μ •μ„ ν•΄μ¤¬μµλ‹λ‹¤.

μ κ°€ μ‚¬μ© μ¤‘μΈ κ³µμ κΈ°λ” ipTIME μ΄κ³ , ν¬νΈ ν¬μ›λ”© μ„¤μ •μ€ λ‹¤λ¥Έ κ³µμ κΈ°λ“¤λ„ λΉ„μ·ν• κ±°λΌκ³  μƒκ°ν•©λ‹λ‹¤.

**ipTime κ΄€λ¦¬λ„κµ¬ -> κ³ κΈ‰ μ„¤μ • -> NAT/λΌμ°ν„° κ΄€λ¦¬ -> ν¬νΈν¬μ›λ“ μ„¤μ •** μμΌλ΅ λ“¤μ–΄κ°€μ¤λ‹λ‹¤.

![](2.png)

μ΄ν›„ **μƒκ·μΉ™ μ¶”κ°€**λ¥Ό ν†µν•΄μ„ μ™Έλ¶€ ν¬νΈλ¥Ό μ„¤μ •ν•κ³  FTP Serverμ— ν•΄λ‹Ήν•λ” λ‚΄λ¶€ IPμ£Όμ†μ™€ λ‚΄λ¶€ ν¬νΈλ¥Ό μ„¤μ •ν•΄μ£Όλ©΄ λ©λ‹λ‹¤.

## FTP Serverκ°€ λΉ„μ •κ· ν¬νΈλ¥Ό μ‚¬μ©ν•λ” κ²½μ°

μΌλ°μ μΌλ΅ μ„ κ³Όμ •κΉμ§€ λ§λ¬΄λ¦¬ν•λ©΄ μ ‘μ†κ³Ό νμΌ μ†΅μμ‹ μ΄ μ›ν™ν•κ² μ΄λ£¨μ–΄μ§‘λ‹λ‹¤. λ‹¤λ§, μ κ°€ ESL Gatewayλ¥Ό λ°›μ•μ„ λ• FTP ν¬νΈ μ„¤μ •μ΄ 21λ² μ •κ· ν¬νΈκ°€ μ•„λ‹λΌ λ‹¤λ¥Έ ν¬νΈλ¥Ό μ‚¬μ©ν•λ” λΉ„μ •κ· ν¬νΈλ΅ λμ–΄μμ—μµλ‹λ‹¤.

μ„μ—μ„ μ„¤λ…ν• κ²ƒμ²λΌ FTP ν†µμ‹  μ‹μ— 21λ² ν¬νΈλ” **Command** ν¬νΈμ΄κ³ , 20λ² ν¬νΈλ” **Data** ν¬νΈμ…λ‹λ‹¤. μ •ν•΄μ§„ κ·μ•½μ΄κΈ° λ•λ¬Έμ— μΌλ°μ μΌλ΅ κ³µμ κΈ°λ‚ λ°©ν™”λ²½μ—μ„ 21λ² ν¬νΈλ¥Ό μ—΄λ©΄ 20λ² ν¬νΈλ„ κ°™μ΄ μ—΄λ¦¬κ² λ©λ‹λ‹¤.

ν•μ§€λ§ λΉ„μ •κ· ν¬νΈλ¥Ό μ‚¬μ©ν•λ” κ²½μ°μ—λ” **FTP μ—°κ²°μ΄ λμ–΄λ„ λ””λ ‰ν† λ¦¬μ™€ νμΌ λ©λ΅μ΄ λ³΄μ΄μ§€ μ•κ±°λ‚ λ°μ΄ν„°λ¥Ό μ „μ†΅ν•  μ μ—†μµλ‹λ‹¤.** μ΄λ¥Ό ν•΄κ²°ν•κΈ° μ„ν•΄μ„ κ³µμ κΈ°μ—μ„ μ¶”κ°€ μ‘μ—…μ„ ν•΄μ¤μ•Όν•©λ‹λ‹¤.

**ipTime κ΄€λ¦¬λ„κµ¬ -> κ³ κΈ‰ μ„¤μ • -> NAT/λΌμ°ν„° κ΄€λ¦¬ -> κ³ κΈ‰ NAT μ„¤μ • -> FTP λΉ„μ •κ· ν¬νΈ** μμΌλ΅ λ“¤μ–΄κ°€μ¤λ‹λ‹¤.

![](3.png)

μ΄ν›„ μ΄λ―Έμ§€μ²λΌ μ‚¬μ©ν•κΈ°λ¥Ό μ›ν•λ” λΉ„μ •κ· ν¬νΈλ¥Ό μ¶”κ°€ν•΄μ£Όλ©΄ μ •μƒμ μΌλ΅ μ‚¬μ©μ΄ κ°€λ¥ν•©λ‹λ‹¤.
